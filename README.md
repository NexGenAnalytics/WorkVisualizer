# Work Visualizer

## Contents

Currently, this repository contains the following directories and files:

1. `caliper.config`: This is the configuration file that will be used to generate the data dumps prior to analysis and visualization. Instructions for use are included below.

2. `mockups/`: This directory contains sample mock-ups for the end result of the Work Visualizer.

3. `data/`: This directory contains sample data generated by running various executables with the configuration file.

3. `plotting_scripts/`: This directory contains Python scripts for plotting and analyzing the generated data.

## Python Plotting Scripts

The `plot_all_data.py` script in `plotting_scripts` takes in a data dump and generates three plots that:
1. Show all MPI and Kokkos calls over time
2. Bin the time range and call counts into discrete time steps (currenty only looking at `MPI_Send`)
3. Perform a Fourier analysis to determine the most suitable period of the program (i.e. the meta slice) -- this plot is still being developed

### Steps to Plot
These instructions assume that the top-level of the Work Visualizer repository has been exported to `$WORKVIZ_DIR`.

1. Install [Caliper](https://github.com/LLNL/Caliper) and add `bin/cali-query` to `$PATH`

2. Export the following environment variables

```
export KOKKOS_TOOLS_LIBS=/path/to/libcaliper.so
export CALI_CONFIG_FILE=${WORKVIZ_DIR}/caliper.config
```

3. Run an executable that uses Kokkos
- This will automatically generate `all-data-<mpi.rank>.cali` files in the directory where you ran the executable (one per rank).

4. Merge these `*.cali` files into a single JSON and move the JSON to the Work Visualizer directory.

For example:

```sh
touch em_4p_100s_alltrace.json # this will contain the data for all ranks
cali-query -q "SELECT * FORMAT json" *.cali | tee em_4p_100s_alltrace.json
mv em_4p_100s_alltrace.json ${WORKVIZ_DIR}/data
```

The plotting script looks for the following naming convention in the data files:
```sh
<app>_<num-procs>p_<num-steps>s_<all/mpi>trace.json
```
- `<app>`: Can be any identifier for the executable that generated the data. The following app identifiers are automatically recognized (so the full app name will be output ont the plots).
  - `em` -> `MiniEM`
  - `mpm` -> `ExaMPM`
  - `md` -> `ExaMiniMD`

- `<num-procs>`: The number of MPI ranks that the executable was run on
- `<num-steps>`: The number of timesteps that the executable was run with
- `<all/mpi>`: Whether or not the JSON contains Kokkos calls (largely for testing purposes).


5. Run the plotting script

The most basic call is:

```
python plotting_scripts/plot_all_data.py -i data/<filename>.json
```

A number of other parameters exist as well:

```
-i  <INPUT>  The input JSON file (this one's not optional)
-s  <SAVE>   Bool: whether or not to save the resulting plots to files
-p  <PROC>   The processor to be plotted (one processor is plotted)
-t  <TARGET> The processor to be colored (all processors are plotted)
-o  <ORDER>  Bool: Sorts the output by call type
-b  <BINS>   The number of bins to use when discretizing for frequency analysis.
```

Of these, the most commonly used are `-i`, `-s`, and `-b`.
